# Traffic Routing

``` bash
$ while true; do curl http://192.168.56.30:31221/hostname; sleep 2; echo ''; done;
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-tlsjg
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-h4qvk
app-1-2-2-1-544d448c8c-tlsjg
```

↑ 2초 간격으로 호출 받은 Pod 의 Hostname 을 출력
* 강제로 특정 Pod 를 정지시키면 자동으로 복구됨
* 새로운 Pod 가 준비 완료될 때 까지 트래픽 조정도 자동적으로 이루어 짐

# Self-Healing

```bash
$ curl 192.168.56.30:31221/memory-leak
```

request 를 받은 pod 에 memory-leak 을 일으킴
- K8s 가 스스로 App restart 진행
  ![[CleanShot 2024-06-09 at 14.59.17@2x.png]]
- restart 중인 pod 에 트래픽을 보내지 않음
- DashBoard
	- Grafana
	  ![[CleanShot 2024-06-09 at 15.01.02@2x.png]]
	- Loki : Error log
	  ![[CleanShot 2024-06-09 at 15.03.08@2x.png]]
	  ![[CleanShot 2024-06-09 at 15.03.29@2x.png]]

# AutoScaling

```bash
$ curl 192.168.56.30:31221/cpu-load
```

![[CleanShot 2024-06-09 at 15.10.42@2x.png]]
↑ 새로운 Pod 가 기동됨

# RollingUpdate

```bash
$ kubectl set image -n default deployment/app-1-2-2-1 app-1-2-2-1=1pro/app-update
```

![[CleanShot 2024-06-09 at 15.17.19@2x 1.png]]
↑ 업데이트 된 새로운 Pod 가 순차적으로 기동되고, 업데이트 동안 트래픽은 끊기지 않음


#K8s #Traffic-Routing #Self-Healing #AutoScaling #RollingUpdate
